<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>FriendFinder</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.5.1/chosen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.5.1/chosen.jquery.min.js"></script>

  

</head>

<body>

    

  <div class="container">

    <h2>Encuentra a tu amigo respondiendo estas preguntas</h2>
    <hr>

    <h3><strong>Sobre Mi</strong></h3>
    <h4>Nombre</h4>
    <input type="text" id="name" class="form-control" required>
    <h4>Tu fotografía (link)</h4>
    <input type="text" id="photo" class="form-control" required>
    <hr>
    <h3><strong>1)</strong></h3>
    <h4>Constantemente piensas en nuevas ideas.</h4>
    <select class="chosen-select" id="p1">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>

    <h3><strong>2)</strong></h3>
    <h4>Confias más en lo aprendido que en la imaginación.</h4>
    <select class="chosen-select" id="p2">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>


    <h3><strong>3)</strong></h3>
    <h4>Bajo presión permaneces relajado.</h4>
    <select class="chosen-select" id="p3">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>


    <h3><strong>4)</strong></h3>
    <h4>Rara vez haces algo solo por mera curiosidad.</h4>
    <select class="chosen-select" id="p4">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>


    <h3><strong>5)</strong></h3>
    <h4>Rara vez la gente te llega a hacer enojar.</h4>
    <select class="chosen-select" id="p5">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>


    <h3><strong>6)</strong></h3>
    <h4>Constantemente te cuesta trabajo sentir empatía por los sentimientos de los demás.</h4>
    <select class="chosen-select" id="p6">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>


    <h3><strong>7)</strong></h3>
    <h4>En una discusión, la verdad es lo importante y no los sentiemientos de los demás.</h4>
    <select class="chosen-select" id="p7">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>

    <h3><strong>8)</strong></h3>
    <h4>Rara vez te dejas llevar por ilusiones e ideas.</h4>
    <select class="chosen-select" id="p8">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>

    <h3><strong>9)</strong></h3>
    <h4>Crees que las opiniones de los demás deben ser respetadas aunque no se basen en hechos.</h4>
    <select class="chosen-select" id="p9">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>

    <h3><strong>10)</strong></h3>
    <h4>Te sientes con más energía después de pasar tiempo con más gente.</h4>
    <select class="chosen-select" id="p10">
      <option value=""></option>
      <option value="1">1 (No es lo mío)</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5 (Si es lo mío)</option>
    </select>

    <br>
    <br>

    
    <button type="submit" class="btn btn-primary btn-lg btn-block" id="submit">
     Submit</button>

    <hr>
    <footer class="footer">
      <div class="container">
        <p><a href="/api/friends">Clic aquí para ver la Api </a> 
      </div>
    </footer>

  </div>

  <!-- Modal -->
  <div id="results-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          
          <h2 class="modal-title"><strong>Mejor coincidencia</strong></h2>
        </div>
        <div class="modal-body">
          <h2 id="match-name"></h2>
          <img id="match-img" src="https://media.licdn.com/mpr/mpr/shrinknp_400_400/p/6/005/064/1bd/3435aa3.jpg" alt="">
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>

    </div>
  </div>





  <style type="text/css">
    #name,#photo {background-color: beige; border:none;}
    
    h3 {color: grey;}
    select{    background-color: black; color: white;}
    #submit{color: white;
    background-color: darkgoldenrod;
    width: 50%;
    margin: auto;
    border: none;}
  </style>






<script type="text/javascript">
//creo un nuevo friends con los datos que se introducen en el survey
$("#submit").on("click", function(event) {
  event.preventDefault();
  var newfriends = {
    name: $("#name").val().trim(),
    photo: $("#photo").val().trim(),
    scores: [
            $("#p1").val(),
            $("#p2").val(),
            $("#p3").val(),
            $("#p4").val(),
            $("#p5").val(),
            $("#p6").val(),
            $("#p7").val(),
            $("#p8").val(),
            $("#p9").val(),
            $("#p10").val()
          ]
  };

  //mando (posteo) la información que acabo de crear aquí arriba a la api y muestro un mensaje
  $.post("/api/friends", newfriends)
    .then(function(data) {
      alert("Procesando...");
  });



//en este get hice toda la lógica para obtener quien es tu match, funciona así:
// A) Hago un parseInt (de string a integer de los scores). Ojo, esto se puede hacer directo desde el momento de obtener el valor.
//    En realidad me sirve también para obtener de la api solo el nuevo valor que acabo de meter, recuerda que en la api estarán
//    todos los valores, los que están ya directo del archivo friends.js y este nuevo.
// B) Obtengo los valores de los friends que ya estaban el el archivo friends.js (sin el nuevo).
//    Al separarlos así puedo hacer la comparativa entre ambos.
// C) Sumo los scores de todos (que recuerda que es un array) y el resultado de eso, el más chico, es tu match.  
// * Abre la consola para ver esto aplicado y desglosado.
  $.get("/api/friends")
    .then(function(data) {
      
      //aquí se alamacena solo el score del newfriends, osea el que se hace al llenar el survey
      var elnewfriends=[];
      //aquí almaceno las sumas de los scores de los candidatos que están ya en el archivo friends.js
      var scorescandidatossumados=[];
      //aquí almaceno los nombres de los candidatos que ya están en el archivo friends.js
      var candidatos=[];


      // A) aquí obtengo el valor del nuevo friends que se hace al llenar el survey
      newfriends.scores.map(function(element) {
          var antesdeelnewfriends=[];
          antesdeelnewfriends= element;
          elnewfriends.push(parseInt(antesdeelnewfriends));  
      });
          console.log("score de este survey", elnewfriends);


      // B) aquí obtengo todos los scores menos el nuevo que acaba de llenar el survey
      for (var i=0; i<(data.length-1); i++){
        console.log("score original de esta persona",data[i].scores,data[i].name);

        //Esta línea se usó de base para sacar la var result, la dejó aquí como guía solamente** var result = data[i].scores.map( (item, ix) => item - elnewfriends[ix] );

        // Aquí saco la resta de mi score menos el score de cada persona (recuerda que ambos scores, son arrays independientes), entonces resto cada index con su correspondiente index. 
        // El math sirve para que la resta de por ej. 5-3=2 y 3-5=2 (y no -2); es decir
        // agarra el número maximo (más grande) - el número minimo o más chico, siempre.
        // El nuevoresult, hace una suma de todo el array que tendrás en result
        var result = data[i].scores.map( (item, ix) => Math.max(item, elnewfriends[ix]) - Math.min(item, elnewfriends[ix]) );
        var nuevoresult= result.reduce(function(a, b){
                          return a + b
                          });

        console.log("esta es la resta de mi score menos el score de esta persona:",result,"esta es la suma de todo ese array", nuevoresult, data[i].name);
        
        // metemos en la variable candidatos los nombres de todos los que están en friends.js
        candidatos.push(data[i].name);
        // metemos a esta variable la suma de nuevo result, (ver un paso arriba)
        scorescandidatossumados.push(nuevoresult);  
      }//----cierre for
     
    
      // C) Busco la persona que tenga menos diferencia de valores en comparación con los valores del que acaba de hacer el survey
      var valormaschico= Math.min(...scorescandidatossumados);
      //obtengo el index del valor más chico (el valor más chico es el que hará match contigo), para así con ese index desplegar su info de foto y nombre
      var elindexdelmatch= scorescandidatossumados.indexOf(valormaschico);
      //apartir de aquí ya tengo: el valor que hizo match contigo, el nombre de ese candidato y la foto de ese candidato
      console.log("este es tu match", valormaschico, candidatos[elindexdelmatch], data[elindexdelmatch].photo);
      
     //ahora como ya tengo los datos (valores) de con quien hice match, los despliego en front en un modal previamente hecho en html
     $("#results-modal").modal("toggle");
     $("#match-name").text(candidatos[elindexdelmatch]);
     $("#match-img").attr("src", data[elindexdelmatch].photo);



      
  });//---cierre get api friends








})//---cierre onclick






  </script>

</body>

</html>
